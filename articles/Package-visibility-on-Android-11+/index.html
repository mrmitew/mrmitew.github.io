<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Package visibility on Android 11+ &middot; Stefan Mitev
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  



  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.png" />

  <!-- RSS -->
<!--  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />-->

  <!-- Additional head bits without overriding original head -->

<script src="/assets/js/jquery-2.1.1.min.js"></script>
</head>


  <body class="post">

    <script src="https://cdn.jsdelivr.net/npm/@klaxit/cookie-consent@0.3.4/dist/cookie-consent.js"></script>
<script>
    const CookieConsent = window.CookieConsent
    const cc = new CookieConsent({
      title: "This website uses cookies üç™",

      description: `Click ‚ÄúAccept‚Äù to enable the webiste to use cookies for analytics and personalization. Customize your preferences in the cookie settings down below or click ‚ÄúReject‚Äù if you do not want the site to use cookies for these purposes. Learn more in the <a href="/cookie-notice">Cookie Notice</a>.`,

      buttons: {
        acceptAll: "Accept",
        acceptSelected: "Accept Cookies",
        reject: "Reject",
        showSettings: "Cookies settings",
        hideSettings: "Hide",
      },

      categories: {
        necessary: {
          label: "Necessary",
          description: `Necessary cookies are needed for features that are essential to your use of this site (e.g. your cookie preference).`,
          checked: true,
          mandatory: true
        },
          
        analytics: {
          label: "Analytics",
          description: `Analytics cookies allow us to analyze your visits and actions on this website.`,
          checked: false,
          mandatory: false
        },
        
        
      },
    })
  </script>
    
    
  <script>
    function updateAnalytics() {
      const MEASURMENT_ID = "UA-138726311-1"
      console.log("measurement", MEASURMENT_ID)
      if (window.CookieConsent.acceptedCategories?.includes("analytics")) {
        window['ga-disable-' + MEASURMENT_ID] = undefined;
          
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', MEASURMENT_ID, { cookieFlags: 'SameSite=None; Secure' })
        ga('set', 'anonymizeIp', true)
        ga('send', 'pageview')
        
      } else {
        window['ga-disable-' + MEASURMENT_ID] = true;
      }
    }
    // Here, you can use either the class CookieConsent or the instance
    // created earlier (cc in this case). Both will emit the same events.
    cc.on("change", (cc) => {
      updateAnalytics()
    })

    updateAnalytics() // to make sure it is loaded once.
  </script>
  
  

    <div id="sidebar">
  <header>
    <img src="/assets/images/avatar.png" id="profile-avatar"/>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Stefan Mitev
      </a>
    </div>
    <p class="lead"></p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  


  
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/about/">About</a>
    
  

  
    
      <a class="page-link "
          href="/speaking/">Speaking</a>
    
  

  
    
      <a class="page-link "
          href="/archive">Archive</a>
    
  


  


  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  <nav id="sidebar-icon-links">
    <a 
       class="icon" title="Github" aria-label="Github"
       href="https://github.com/mrmitew">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

    </a>
    <a
        class="icon" title="LinkedIn" aria-label="LinkedIn"
        href="https://nl.linkedin.com/in/stefan-mitev-82546972">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/></svg>
    </a>
    <a
       class="icon" title="Twitter" aria-label="Twitter"
       href="https://twitter.com/steffmitev">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg>
    </a>

<!--  <a id="subscribe-link"-->
<!--     class="icon" title="Subscribe" aria-label="Subscribe"-->
<!--     href="/feed.xml">-->
<!--    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>-->
<!--  </a>-->

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10.605 0h-10.605v10.609l13.391 13.391 10.609-10.604-13.395-13.396zm-4.191 6.414c-.781.781-2.046.781-2.829.001-.781-.783-.781-2.048 0-2.829.782-.782 2.048-.781 2.829-.001.782.782.781 2.047 0 2.829z"/></svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M23.809 21.646l-6.205-6.205c1.167-1.605 1.857-3.579 1.857-5.711 0-5.365-4.365-9.73-9.731-9.73-5.365 0-9.73 4.365-9.73 9.73 0 5.366 4.365 9.73 9.73 9.73 2.034 0 3.923-.627 5.487-1.698l6.238 6.238 2.354-2.354zm-20.955-11.916c0-3.792 3.085-6.877 6.877-6.877s6.877 3.085 6.877 6.877-3.085 6.877-6.877 6.877c-3.793 0-6.877-3.085-6.877-6.877z"/></svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p style="font-size: 14px">
  &copy; 2022.
  <a href="/LICENSE.md">Apache 2.0</a> <br/> 
  <a href="/cookie-notice/">Cookie notice</a> |
  <a href="/privacy-policy/">Privacy policy</a>
</p>


  
</div>

    <main class="container">
      <header>
  <h1 class="post-title">Package visibility on Android 11+</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">19 Jun 2022</span>
  <span class="post-categories">
    
  </span>
</div>


  <div class="post-body">
    <p>Android 11 is an old news, yep (unless you have lived under a rock for a while). However, from July 12th 2022, Google is going to enforce a <a href="https://support.google.com/googleplay/android-developer/answer/10158779">policy</a> that affects apps targetting Android 11+ (API 30+), which.. makes this article still kind-of relevant.</p>

<p>So what‚Äôs going on you wonder? Let me explain some things that changed in Android 11 first.</p>

<h2 id="limited-package-visibility">Limited package visibility</h2>

<p>By <a href="https://developer.android.com/training/package-visibility/automatic">default</a>, apps that query the system for other apps that are installed, will be able to get information only about:</p>
<ul>
  <li>Their own app</li>
  <li>System apps</li>
  <li>Other apps that starts/binds a service in their app</li>
  <li>Other apps that access a content provider in their app</li>
  <li>Other apps that receive an input from their app as an Input Method Editor (IME)</li>
</ul>

<p>That means that if your app uses explicit intents to other apps or any of the below APIs, it might be affected.</p>
<ul>
  <li><code class="highlighter-rouge">queryIntentActivities()</code></li>
  <li><code class="highlighter-rouge">getPackageInfo()</code></li>
  <li><code class="highlighter-rouge">getInstalledApplications()</code></li>
  <li><code class="highlighter-rouge">queryBroadcastReceivers()</code></li>
  <li><code class="highlighter-rouge">queryIntentServices()</code></li>
  <li><code class="highlighter-rouge">getLaunchIntentForPackage()</code></li>
  <li><code class="highlighter-rouge">getInstalledPackages()</code></li>
</ul>

<p>Why would you not be able to launch another app with an explciit intent? Well, just so you won‚Äôt abuse the system to find out whether a specific app is installed or not, without having the intentions to launch it.</p>

<p>So what could you do? You have few options:</p>
<ul>
  <li><strong>Launch an activitiy of another app with an implicit intent</strong></li>
  <li><strong>Make use of the <code class="highlighter-rouge">&lt;queries&gt;</code> manifest element</strong></li>
  <li><strong>Declare <code class="highlighter-rouge">QUERY_ALL_PACKAGES</code></strong> permission</li>
</ul>

<p>Let‚Äôs take a closer look at each one of them.</p>

<h3 id="launch-an-activitiy-of-another-app-with-an-implicit-intent">Launch an activitiy of another app with an implicit intent</h3>
<p>If you want to a launch another app, you might try to do something like</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">intent</span> <span class="p">=</span> <span class="n">packageManager</span><span class="p">.</span><span class="nf">getLaunchIntentForPackage</span><span class="p">(</span><span class="s">"com.another.app"</span><span class="p">)</span>
<span class="nf">startActivity</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
</code></pre></div></div>

<p>However, the intent will be <code class="highlighter-rouge">null</code> (since its an explicit intent) and your app will actually crash with a NPE. To make it work, you‚Äôd need make additional changes using the <code class="highlighter-rouge">&lt;queries&gt;</code> Manifest element (read below for more information).</p>

<p>For instance, if the app that you want to launch declares an intent filter with a custom scheme, you could do something like:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">intent</span> <span class="p">=</span> <span class="nc">Intent</span><span class="p">(</span><span class="nc">Intent</span><span class="p">.</span><span class="nc">ACTION_VIEW</span><span class="p">).</span><span class="nf">apply</span> <span class="p">{</span>
    <span class="n">data</span> <span class="p">=</span> <span class="nc">Uri</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s">"custom-scheme://something"</span><span class="p">)</span>  
<span class="p">}</span>
<span class="nf">startActivity</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
</code></pre></div></div>

<p>However, since it is not an explicit intent, there could be another app that could also be able to try handle the intent. In some cases, that‚Äôd be exactly what you would want though (e.g. opening a PDF with whatever app there is available). And if you were to use the above intent to query all activities that can handle it, you will get an empty list (unless the app(s) is visible to your app).</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">queryIntentActivities</span> <span class="p">=</span> <span class="n">packageManager</span><span class="p">.</span><span class="nf">queryIntentActivities</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="nc">PackageManager</span><span class="p">.</span><span class="nc">MATCH_ALL</span><span class="p">)</span> <span class="c1">// returns empty list</span>
</code></pre></div></div>

<h3 id="make-use-of-the-queries-manifest-element">Make use of the <code class="highlighter-rouge">&lt;queries&gt;</code> manifest element</h3>
<p>Given a matching package name, intent signature or provider authority, you could make other apps visible to yours. Simply declare those inside <code class="highlighter-rouge">&lt;queries&gt;</code> manifest element. E.g.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;manifest</span> <span class="na">package=</span><span class="s">"com.my.app"</span><span class="nt">&gt;</span>  
    <span class="nt">&lt;queries&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">android:name=</span><span class="s">"com.some.app‚Äù /&gt;
            &lt;intent&gt;
                &lt;action android:name="</span><span class="err">android.intent.action.SEND"</span> <span class="nt">/&gt;</span>  
                <span class="nt">&lt;data</span> <span class="na">android:mimeType=</span><span class="s">"image/jpeg"</span> <span class="nt">/&gt;</span>  
            <span class="nt">&lt;/intent&gt;</span>
        <span class="nt">&lt;provider</span> <span class="na">android:authorities=</span><span class="s">"com.example.settings.files"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/queries&gt;</span>  
¬† ¬† ...
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div></div>

<p>Then you‚Äôd be able to use any of the APIs I mentioned earlier to get information about the apps from the system or be able to construct a launching intent.</p>

<h3 id="declare-query_all_packages-permission">Declare <code class="highlighter-rouge">QUERY_ALL_PACKAGES</code> permission</h3>
<p>If none of the alternatives, mentioned earlier, don‚Äôt suit you, <code class="highlighter-rouge">QUERY_ALL_PACKAGES</code> might be the solution for you. However, in order for your app to be published on Google Play store, your app needs to fall into a specific category, then fill a declaration form and finally be approved by Google.</p>

<p>These are the types of apps and use cases, that Google allows (for now):</p>
<ul>
  <li>Accessibility apps</li>
  <li>Browsers</li>
  <li>Device management apps</li>
  <li>Security apps</li>
  <li>Antivirus apps</li>
  <li>Financial-transaction apps</li>
</ul>

<p>For more information, please refer to the links at the end of the article.</p>

<h2 id="tips">Tips</h2>

<h3 id="find-usages-of-the-restricted-apis">Find usages of the restricted APIs</h3>
<p>If you work on a very small project with not many dependencies, it might be doable to manually go through all the files and see whether any of your features are using any of the restricted APIs. However, this would still be quite consuming. And if you work on a big project like I do (10+ teams), it is ‚Äúimpossible‚Äù to go through all the code and dependencies.</p>

<p>A simple way to automate this, is to search through the <a href="https://source.android.com/devices/tech/dalvik/dex-format">dex</a> (Dalvik Executable Format) files of your app‚Äôs apk. You can use <code class="highlighter-rouge">dexdump</code> to decompile the DEX files and <code class="highlighter-rouge">grep</code> to search for the usage of the restricted APIs.</p>

<ol>
  <li>Unzip the <code class="highlighter-rouge">.dex</code> files from your <code class="highlighter-rouge">.apk</code>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unzip my-app.apk <span class="s2">"*.dex"</span>
</code></pre></div>    </div>
  </li>
  <li>Search through all the dex files
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> ./<span class="k">*</span>.dex | xargs <span class="nt">-L1</span> <span class="nt">-I</span> <span class="o">{}</span> dexdump <span class="nt">-d</span> <span class="o">{}</span> | <span class="nb">grep </span>queryIntentActivities
</code></pre></div>    </div>
  </li>
</ol>

<p>You can use <code class="highlighter-rouge">-B[number]</code> and <code class="highlighter-rouge">-A[number]</code> to get X lines before and after occurrance, so that you get the context of usage.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> ./<span class="k">*</span>.dex | xargs <span class="nt">-L1</span> <span class="nt">-I</span> <span class="o">{}</span> dexdump <span class="nt">-d</span> <span class="o">{}</span> | <span class="nb">grep </span>queryIntentActivities ‚ÄìB100 <span class="nt">-A100</span>
</code></pre></div></div>

<p><em>PS: Make sure  <code class="highlighter-rouge">dexdump</code> is on your PATH or add the full path to it when you call it. You can find it in <code class="highlighter-rouge">$ANDROID_HOME/build-tools/&lt;version&gt;/dexdump</code>. On my computer, <code class="highlighter-rouge">$ANDROID_HOME</code> is <code class="highlighter-rouge">/Users/$USER/Library/Android/sdk/</code>, but on your machine might be different.</em></p>

<h3 id="which-packages-are-visible-by-everyone-by-default-on-my-device">Which packages are visible by everyone by default on my device?*</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell dumpsys package queries
</code></pre></div></div>
<p>*<em>look for forceQueryable</em></p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://developer.android.com/training/package-visibility">Package visibility filtering on Android</a></li>
  <li><a href="https://developer.android.com/training/package-visibility/automatic">Know which packages are visible automatically</a></li>
  <li><a href="https://developer.android.com/training/package-visibility/declaring">Declaring package visibility needs</a></li>
  <li><a href="https://developer.android.com/training/package-visibility/use-cases">Fulfilling common use cases while having limited package visibility</a></li>
  <li><a href="https://developer.android.com/training/package-visibility/testing">Testing package visibility behavior</a></li>
  <li><a href="https://medium.com/androiddevelopers/package-visibility-in-android-11-cc857f221cd9">Package visibility in Android 11</a></li>
  <li><a href="https://support.google.com/googleplay/android-developer/answer/10158779">Use of the broad package (App) visibility (QUERY_ALL_PACKAGES) permission</a></li>
</ul>

    



<div class="post-tags">
  
    
    <a href="/tags/#android">
    
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10.605 0h-10.605v10.609l13.391 13.391 10.609-10.604-13.395-13.396zm-4.191 6.414c-.781.781-2.046.781-2.829.001-.781-.783-.781-2.048 0-2.829.782-.782 2.048-.781 2.829-.001.782.782.781 2.047 0 2.829z"/></svg>
      </span>&nbsp;<span class="tag-name">android</span>
    </a>
  
</div>
  </div>

  
  
</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
